import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
from google.colab import drive
from sklearn.neural_network import MLPRegressor
from sklearn.preprocessing import MinMaxScaler

# Mount Google Drive
drive.mount('/content/drive')
file_path = "/content/drive/MyDrive/Shopping Mall Analysis Clustered.xlsx"

# Φόρτωση δεδομένων
df = pd.read_excel(file_path)

df['Price'] = df['Price'].astype(float)
df['Quantity'] = df['Quantity'].astype(int)
df['Total Spend'] = df['Total Spend'].astype(float)

# Δημιουργία DayType
weekend_days = ['Saturday','Sunday']
df['DayType'] = df['Day'].apply(lambda x: 'Weekend' if x in weekend_days else 'Weekday')

# AgeGroup
bins = [0,25,40,60,120]
labels = ['<25','25-40','40-60','60+']
df['AgeGroup'] = pd.cut(df['Age'], bins=bins, labels=labels)

category_summary = df.groupby('Category').agg({
    'Price':'mean',
    'Quantity':'mean',
    'Total Spend':'mean'
}).reset_index()

print(category_summary)

# Γράφημα Total Spend ανά Category
plt.figure(figsize=(10,6))
sns.barplot(x='Category', y='Total Spend', data=df, color='skyblue')
plt.title("Average Total Spend per Category")
plt.ylabel("Total Spend")
plt.xticks(rotation=45)
plt.show()

season_summary = df.groupby(['Season','Category'])['Total Spend'].sum().reset_index()

plt.figure(figsize=(10,6))
sns.barplot(data=season_summary, x='Season', y='Total Spend', hue='Category')
plt.title("Total Spend per Season per Category")
plt.ylabel("Total Spend")
plt.show()

mall_summary = df.groupby(['Shopping_mall','Category'])['Total Spend'].sum().reset_index()

plt.figure(figsize=(12,6))
sns.barplot(data=mall_summary, x='Shopping_mall', y='Total Spend', hue='Category')
plt.title("Total Spend per Shopping Mall per Category")
plt.ylabel("Total Spend")
plt.xticks(rotation=45)
plt.show()

daytype_summary = df.groupby(['DayType','Category'])['Total Spend'].sum().reset_index()

plt.figure(figsize=(8,5))
sns.barplot(data=daytype_summary, x='DayType', y='Total Spend', hue='Category')
plt.title("Total Spend per Day Type per Category")
plt.ylabel("Total Spend")
plt.show()

month_category = df.groupby(['Month','Category'])['Total Spend'].sum().unstack()
plt.figure(figsize=(12,6))
sns.heatmap(month_category, annot=True, fmt=".0f", cmap="YlGnBu")
plt.title("Total Spend per Month per Category")
plt.show()

# Δημιουργούμε σύνολο πωλήσεων ανά Category και Quarter
category_sales = df.groupby(['Category','Quarter'])['Total Spend'].sum().reset_index()
print(category_sales)

category_pivot = category_sales.pivot(index='Quarter', columns='Category', values='Total Spend').fillna(0)
print(category_pivot)

from statsmodels.tsa.holtwinters import ExponentialSmoothing

forecast_dict = {}

for cat in category_pivot.columns:
    ts = category_pivot[cat]
    if len(ts) < 3:
        # μέση τιμή
        forecast_dict[cat] = ts.mean()
    else:
        # Trend (χωρίς seasonal)
        model = ExponentialSmoothing(ts, trend='add', seasonal=None)
        fit = model.fit()
        forecast = fit.forecast(steps=1)
        forecast_dict[cat] = forecast.values[0]

print("Forecasted Total Spend for next Quarter (trend-based):")
print(forecast_dict)

# Προετοιμασία δεδομένων
df['Total Spend'] = df['Total Spend'].astype(float)
category_pivot = df.pivot_table(index='Quarter', columns='Category', values='Total Spend', aggfunc='sum').fillna(0)

# MLP Forecasting Logic
forecast_dict = {}

print("Εκκίνηση MLP Forecast (Deep Learning)...")

for cat in category_pivot.columns:
    series = category_pivot[cat].values.reshape(-1, 1)

    if len(series) < 4:
        forecast_dict[cat] = series.mean()
    else:
        # α. Κανονικοποίηση (Scaling)
        scaler = MinMaxScaler()
        series_scaled = scaler.fit_transform(series)

        # β. Δημιουργία Features (Lags)
        # Χρησιμοποιούμε την τιμή του τριμήνου t για να προβλέψουμε το t+1
        X = series_scaled[:-1]
        y = series_scaled[1:].ravel()

        # γ. Ορισμός και Εκπαίδευση MLP Regressor
        # Χρησιμοποιούμε 2 κρυφά επίπεδα (hidden layers)
        mlp = MLPRegressor(
            hidden_layer_sizes=(50, 25),
            activation='relu',
            solver='adam',
            max_iter=2000,
            random_state=42
        )
        mlp.fit(X, y)

        # δ. Πρόβλεψη για το επόμενο τρίμηνο
        last_val_scaled = series_scaled[-1].reshape(1, -1)
        next_val_scaled = mlp.predict(last_val_scaled)

        # ε. Επαναφορά στην αρχική κλίμακα (Inverse Transform)
        next_val = scaler.inverse_transform(next_val_scaled.reshape(-1, 1))
        forecast_dict[cat] = next_val[0][0]

# Οπτικοποίηση Αποτελεσμάτων
forecast_df = pd.DataFrame(list(forecast_dict.items()), columns=['Category', 'Forecast'])
forecast_df.set_index('Category', inplace=True)

plt.figure(figsize=(14, 7))
quarters = list(category_pivot.index)

for cat in category_pivot.columns:
    sales = category_pivot[cat].values
    color = plt.gca()._get_lines.get_next_color()

    # Ιστορικά δεδομένα
    plt.plot(quarters, sales, label=f"{cat} (Actual)", marker='o', color=color)

    # MLP Forecast
    plt.plot([quarters[-1], 'Next_Q'], [sales[-1], forecast_df.loc[cat,'Forecast']],
             linestyle='--', marker='s', color=color, alpha=0.7, label=f"{cat} (MLP Forecast)")

plt.title("Sales Prediction using Deep Learning MLP (Multilayer Perceptron)", fontsize=16)
plt.xlabel("Quarter", fontsize=12)
plt.ylabel("Total Spend", fontsize=12)
plt.xticks(list(quarters) + ['Next_Q'])
plt.legend(bbox_to_anchor=(1.05, 1), loc='upper left')
plt.grid(alpha=0.3)
plt.tight_layout()
plt.show()

print("\nΟι προβλέψεις MLP ολοκληρώθηκαν:")
print(forecast_df)
